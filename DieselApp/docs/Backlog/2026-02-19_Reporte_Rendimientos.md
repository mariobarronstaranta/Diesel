Requerimiento

Generar un reporte de consumos de diesel el cual haga una relacion entre la cantidad de litros consumidos , con relacion Horometro y el Odometro
Solo consierar los movimientos TipoMovimiento = S de la tabla TanqueMovimiento

Generar una funcion para supabase que cumpla con la especificacion de los filtros de entrada y los datos de salida

Agregar este reporte dentro del menu reportes con el nombre "Reporte Rendimiento"

# Filtros

Ciudad
Tanque
Fecha Inicial
Fecha Final

# Datos de Salida

> **Nota (2026-02-19):** Se eliminó la columna Fecha del resultado para mostrar totales acumulados por Tanque/Unidad en el rango de fechas seleccionado.

Tanque
Unidad  
Carga Total
Kms Recorridos
Hrs Recorridos
Kms/Lts  
Hrs/Lts

# Detalle de Calculo de Columnas

Tanque : Campo Nombre de Tabla Tanque
Unidad : Campo IDClaveUnidad + "(" + ClaveAlterna + ")" de la tabla de Unidades
Carga Total : sum(LitrosCarga)
Km Recorridos : max(Odometro) - min(Odometro)
Hrs Recorridos : max(Horimetro) - min(Horimetro)
Kms/Lts - ( max(Odometro) - min(Odometro) ) / SUM(LitrosCarga)
Hrs/Lts - ( max(Horimetro) - min(Horimetro) ) / SUM(LitrosCarga)

# Tablas Involucradas en supabase

create table public."TanqueMovimiento" (
"IdTanqueMovimiento" bigint generated by default as identity not null,
"CveCiudad" character varying not null,
"IdTanque" bigint not null,
"FechaCarga" date not null,
"HoraCarga" time without time zone not null,
"TemperaturaCarga" bigint not null,
"LitrosCarga" bigint not null,
"AlturaTanque" bigint null,
"CuentaLitros" bigint null,
"Remision" character varying null,
"IdProveedor" bigint null,
"Observaciones" character varying null,
"TipoMovimiento" character varying null,
"FechaHoraMovimiento" timestamp without time zone null,
"IdUnidad" bigint null,
"IdPersonal" bigint null,
"FolioVale" character varying null,
"Horimetro" bigint null,
"Odometro" bigint null,
constraint TanqueMovimiento_pkey primary key ("IdTanqueMovimiento")
) TABLESPACE pg_default;

create table public."Unidades" (
"IDUnidad" bigint not null,
"IDClaveUnidad" text null,
"ClaveAlterna" text null,
"Borrado" text null,
"IDPlanta" bigint null,
"Planta" text null,
"CveCiudad" text null,
"IDMarca" bigint null,
"MarcaCamion" text null,
"IDTipoCombustible" bigint null,
"TipoCombustible" text null,
"IDTipoPlacas" bigint null,
"TipoPlacas" text null,
"Activo" text null,
"Modelo" text null,
"NumSerie" text null,
"Placas" text null,
constraint Unidades_pkey primary key ("IDUnidad")
) TABLESPACE pg_default;

create table public."Tanque" (
"IDTanque" integer not null,
"Nombre" text not null,
"CveCiudad" text not null,
"IDPlanta" integer not null,
"Capacidad" bigint null,
"IDTipoCombustible" integer null,
"TipoCombustible" text null,
"Forma" text null,
"DiametroA" bigint null,
"Largo" bigint null,
idciudad character varying null,
constraint Tanque_pkey primary key ("IDTanque"),
constraint Tanque_IDTanque_key unique ("IDTanque"),
constraint Tanque_IDPlanta_fkey foreign KEY ("IDPlanta") references "Planta" ("IDPlanta")
) TABLESPACE pg_default;

Relaciones INNER JOIN
TanqueMovimiento.IdTanque = Tanque.IDTanque
TanqueMovimiento.IDUnidad = Unidades.IDUnidad

# Plan de Acción y Estado Actual

## ✅ Completado (19 de Febrero de 2026)

- Script SQL creado en `docs/Scripts/Rendimientos.sql` con función `public.reporte_rendimientos(p_fecha_inicio, p_fecha_fin, p_cve_ciudad, p_id_tanque)`. Fechas obligatorias, ciudad como `text`, División protegida con `NULLIF`.
- Columna **Fecha** eliminada del resultado — el reporte muestra totales acumulados por Tanque/Unidad en el rango de fechas.
- Componente visual `src/components/ReporteRendimientos.tsx` implementado con filtros, tabla de resultados y exportación CSV.
- Ruta `/reportes/rendimiento` registrada en `src/App.tsx`.
- Entrada **Rendimiento** agregada al menú desplegable de Reportes en `src/components/TopNav.tsx`.
- Tipos TypeScript añadidos en `src/types/reportes.types.ts` (`ReporteRendimientosData`, `ReporteRendimientosForm`).
- Documentación técnica del componente en `docs/components/ReporteRendimientos.md`.
- Bitácora del día actualizada en `docs/Bitacora/2026-02-19_summary.md`.

## ⏳ Pendiente

1. Ejecutar `docs/Scripts/Rendimientos.sql` en Supabase para crear la función RPC.
2. Validar en producción que los campos `Odometro` y `Horimetro` tengan datos correctos en `TanqueMovimiento`.

---

## Actualización: Modal de Detalle (2026-02-22)

### Objetivo
Agregar un modal de detalle que muestre los movimientos individuales (`TanqueMovimiento`) que conforman cada renglón acumulado del Reporte de Rendimientos.

### Cambios Realizados

#### SQL (Supabase)
1. **`docs/Scripts/Rendimientos.sql`**: Se agregó la columna `IDUnidad BIGINT` al `RETURNS TABLE` y al `SELECT`, y se incluyó `u."IDUnidad"` en el `GROUP BY`. Esto permite pasar el ID exacto de la unidad al abrir el modal.

2. **`docs/Scripts/get_rendimientos_detalle.sql`** [NEW]: Nueva función `get_rendimientos_detalle(p_fecha_inicio, p_fecha_fin, p_cve_ciudad, p_id_tanque, p_id_unidad)` que retorna los movimientos individuales filtrados por Tanque, Unidad y rango de fechas.

> **Nota:** Ambos scripts deben ejecutarse en el SQL Editor de Supabase.

#### Frontend
- **`src/types/reportes.types.ts`**: Se agregó `IDUnidad: number` a `ReporteRendimientosData` y se creó la interfaz `RendimientoDetalleItem`.
- **`src/components/ReporteRendimientosDetalleModal.tsx`** [NEW]: Nuevo modal que carga y muestra la tabla de movimientos individuales con columnas: ID Movimiento, Fecha, Hora, Litros, Cuenta Litros, Horómetro, Odómetro. Incluye fila de totales y exportación CSV.
- **`src/components/ReporteRendimientos.tsx`**: Se agregó la columna **Acción** con botón **Detalle**, los estados `showDetalle` y `filaSeleccionada`, y se incorporó el modal al final del JSX.

### Estado
- ✓ Frontend compila sin errores (`npm run build`).
- ⏳ **Pendiente**: Ejecutar `Rendimientos.sql` actualizado y `get_rendimientos_detalle.sql` en Supabase.
